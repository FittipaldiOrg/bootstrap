name: Create Project

on:
  pull_request:
    types: [ closed ]

jobs:
  create_project:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          if [[ "${{ github.event.pull_request.base.ref }}" != "main" ]]; then
            echo "PR not merged into main. Exiting workflow."
            exit 1
          fi

      - name: Check if PR is merged
        run: |
          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "PR not merged. Exiting."
            exit 1
          fi

      - name: Checkout bootstrap repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          path: bootstrap

      - name: Install yq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Find added YAML files
        id: find_yaml
        run: |
          cd bootstrap
          files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.merge_commit_sha }} -- . :^.github | grep '\.yaml$' || true)

          if [[ -n "$files" ]]; then
            echo "changed_files<<EOF" >> $GITHUB_ENV
            echo "$files" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Extract service.name from YAML files
        id: extract_service_name
        run: |
          for file in ${{ env.changed_files }}; do
            echo "Processing: $file"
            service_name=$(yq e '.service.name' "bootstrap/$file")
            echo "Service Name: $service_name"
            echo "SERVICE_NAME=$service_name" >> $GITHUB_ENV
          done

      - name: Print extracted service names
        run: |
          echo "Extracted Service Name: $SERVICE_NAME"

      # Example: You can now use $SERVICE_NAME in a future step
      # - name: Create repository using GitHub API
      #   run: |
      #     curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
      #     -d '{"name": "'"$SERVICE_NAME"'", "private": false}' \
      #     https://api.github.com/orgs/YOUR_ORG_NAME/repos
